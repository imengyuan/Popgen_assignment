---
title: "EEB459 group assignment 4"
author: "Meng"
output: pdf_document
fontsize: 11pt
---

```{r setup, include=FALSE}
# options(scipen=999) # 
```
Note that allele frequency p is assumed to be the frequency of A allele.

## 1) MakeHWfreq()
```{r}
MakeHWfreq <- function(p){
    p_AA = p * p
    p_Aa = 2 * p * (1-p)
    p_aa = (1-p)^2
    return(c(p_AA, p_Aa, p_aa))
}

MakeHWfreq(0.1)
MakeHWfreq(0.5)
MakeHWfreq(0.9)
```

\  

## 2) DoDrift()
```{r}
DoDrift <- function(popSize, EGFvec){
    # sample 5 times at this generation
    prob_vector <- rmultinom(5, popSize, EGFvec)
    return(prob_vector*popSize)
}

# a
popSize = 100
EGFvec = c(0.5, 0, 0.5)
DoDrift(popSize, EGFvec)

# b
popSize = 10^6
EGFvec = c(0.5, 0, 0.5)
DoDrift(popSize, EGFvec)

# c
popSize = 100
EGFvec = MakeHWfreq(0.5) 
DoDrift(popSize, EGFvec)

# d
popSize = 10^6
EGFvec = MakeHWfreq(0.5)
DoDrift(popSize, EGFvec)
```

### Results
The differences of the result make sense. The larger the population size is, the less the numbers of each genotype change or fluctuate, the closer they are to the expected values. This pattern is consistent when using different expected genotype frequencies.

\  

## 3) DoSelection()
```{r}
DoSelection <- function(h, s, GNvec){
    # genotype frequencies
    Geno_freq <- GNvec/sum(GNvec)
    # selection model
    W_AA = 1 + s
    W_Aa = 1 + h * s
    W_aa = 1
    W_vector <- c(W_AA, W_Aa, W_aa)
    W_mean = sum(W_vector * Geno_freq)
    s_Geno_freq <- Geno_freq * W_vector / W_mean
    # allele frequency
    p = s_Geno_freq[1] + 0.5 * s_Geno_freq[2]
    return(p)
}

# a
h=0
s=0.1
GNvec=c(0,333,333)
DoSelection(h, s, GNvec)

# b 
h=0.5
s=0.1
GNvec=c(0,333,333)
DoSelection(h, s, GNvec)

# GNvec as a 2d matrix
DoSelection2 <- function(h, s, GNvec){
    # genotype frequencies
    Geno_freq <- GNvec/colSums(GNvec)
    # selection model
    W_AA = 1 + s
    W_Aa = 1 + h * s
    W_aa = 1
    W_vector <- c(W_AA, W_Aa, W_aa)
    W_mean = colSums(W_vector * Geno_freq)
    s_Geno_freq <- W_vector *  Geno_freq / W_mean
    # allele frequency
    p = s_Geno_freq[1,] + 0.5 * s_Geno_freq[2,]
    return(p)
}

# test example, to be deleted
# GNvec = DoDrift(popSize = 100, EGFvec = MakeHWfreq(0.5))
# Geno_freq<-GNvec/colSums(GNvec)
# colSums(Geno_freq)
# W_vector<-c(1.1, 1.1, 1)
# W_mean = colSums(W_vector * Geno_freq) 
# s_Geno_freq <- W_vector *  Geno_freq / W_mean
# colSums(s_Geno_freq)
# p = s_Geno_freq[1,] + 0.5 * s_Geno_freq[2,]

# c
h=1
s=0.1
GNvec=c(333,666,333)
DoSelection(h, s, GNvec)

# d
h = 1
s = 0.1
GNvec = DoDrift(popSize = 100, EGFvec = MakeHWfreq(0.5))
GNvec/colSums(GNvec)
DoSelection2(h, s, GNvec) 

# e
h = 1 
s = 0.1 
GNvec = DoDrift(popSize = 10^6, EGFvec = MakeHWfreq(0.5))
DoSelection2(h, s, GNvec)
```

### Results
__a vs b__: In both a) and b), there are only two genotypes Aa and aa, the initial allele frequency of A is p=333/666*0.5=0.25. In a), h=0, s=0.1, the fitness of Aa and aa is the same, after selection the genotype frequencies don't change, thus allele frequency p doesn't change (p=0.25). In b), h=0.5,s=0.1, the fitness of Aa genotype is larger than aa by hs=0.05, after selection, the frequency of Aa increases, allele frequency p increases (p=0.256).

__c vs d vs e__: in all three cases, the fitness of genotypes are W_AA=W_Aa=1.1 > W_aa=1, we expect allele frequency p to increase after selection. In d) and e), genetic drift diviate allele and genotype frequencies from the expected values, the larger the population size is (e), the less drift will make an influence, the closer the allele and genotype frequencies are to the expected value before and after selection. If the population size is small, the allele and genotype frequencies can be smaller or larger than expected (before and after selection) due to drift.

\  

## 4) DoOneFullGeneration()
```{r}
DoOneFullGeneration <- function(h, s, popSize, p){
    EGFvec = MakeHWfreq(p)
    GNvec = DoDrift(popSize, EGFvec)
    return(DoSelection2(h, s, GNvec))
}

# a
h=1
s=0.1
n=100
p=0.5
DoOneFullGeneration(h, s, n, p)

# b
h=1
s=0.1
n=10^6
p=0.5
DoOneFullGeneration(h, s, n, p)
```

\  

## 5) DoManyGenerations()
```{r}
DoDrift <- function(popSize, EGFvec){
    # sample once at each generation
    prob_vector <- rmultinom(1, popSize, EGFvec)
    return(prob_vector*popSize)
}

DoOneFullGeneration <- function(h, s, popSize, p){
    EGFvec = MakeHWfreq(p)
    GNvec = DoDrift(popSize, EGFvec)
    return(DoSelection(h, s, GNvec))
}

DoManyGenerations <- function(h, s, popSize, p0, g){
    p_list <- c(p0)
    for(i in 1:g){
        p<-DoOneFullGeneration(h, s, n, p0)
        p_list<-append(p_list, p, after = length(p_list))
        p0<-p
    }
    return(p_list)
}

# a
h=0.5
s=0.1
n=100
p0=0.5
g=500
outputa<-c()
for (i in 1:5){
outputa<-append(outputa, DoManyGenerations(h, s, n, p0, g), after = length(outputa))}
# b
h=0.5
s=0.1
n=10^6
p0=0.5
g=500
outputb<-c()
for (i in 1:5){
outputb<-append(outputb, DoManyGenerations(h, s, n, p0, g), after = length(outputb))}
# c
h=0.5
s=0.01
n=100
p0=0.5
g=500
outputc<-c()
for (i in 1:5){
outputc<-append(outputc, DoManyGenerations(h, s, n, p0, g), after = length(outputc))}
# d
h=0.5
s=0.01
n=10^6
p0=0.5
g=500
outputd<-c()
for (i in 1:5){
outputd<-append(outputd, DoManyGenerations(h, s, n, p0, g), after = length(outputd))}
# e
h=0.5
s=0.01
n=100
p0=0.05
g=500
outpute<-c()
for (i in 1:5){
outpute<-append(outpute, DoManyGenerations(h, s, n, p0, g), after = length(outpute))}
# f
h=0.5 
s=0.01
n=10^6
p0=0.05
outputf<-c()
for (i in 1:5){
outputf<-append(outputf, DoManyGenerations(h, s, n, p0, g), after = length(outputf))}
# g
h=0.5
s=0.01
n=10^6
p0=0.005
g=500
outputg<-c()
for (i in 1:5){
outputg<-append(outputg, DoManyGenerations(h, s, n, p0, g), after = length(outputg))}
```


```{r echo=FALSE}
# plot allele frequency over time
par(mfrow=c(2,4))
# a
ThisLength = length(outputa)/5
plot(rep(1: ThisLength, 5), outputa, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="a",sub="s=0.1,n=100,p0=0.5", xlab = "Generation", ylab ="Allele frequency")
# b
plot(rep(1: ThisLength, 5), outputb, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="b", sub="s=0.1,n=10^6,p0=0.5", xlab = "Generation", ylab ="Allele frequency")
# c
plot(rep(1: ThisLength, 5), outputc, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="c", sub="s=0.01,n=100,p0=0.5", xlab = "Generation", ylab ="Allele frequency")
# d
plot(rep(1: ThisLength, 5), outputd, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="d",sub ="s=0.01,n=10^6,p0=0.5", xlab = "Generation", ylab ="Allele frequency")
# e
plot(rep(1: ThisLength, 5), outpute, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="e", sub="s=0.01,n=100,p0=0.05", xlab = "Generation", ylab ="Allele frequency")
# f
plot(rep(1: ThisLength, 5), outputf, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="f", sub="s=0.01,n=10^6,p0=0.05", xlab = "Generation", ylab ="Allele frequency")
# g
plot(rep(1: ThisLength, 5), outputg, col = c(rep("red", ThisLength), rep("blue", ThisLength), rep("black", ThisLength), rep("green", ThisLength), rep("orange", ThisLength)), main="g",sub="s=0.01,n=10^6,p0=0.005", xlab = "Generation", ylab ="Allele frequency")
```

### Results
__a vs b__: Fitness of AA and Aa are higher than aa, allele A will go to fixation eventually, if population sizeis smaller, there are more fluctuations in allele frequencies untill fixation.

__a vs. c as well as b vs d__: Selection is weaker (hs is smaller) in c & d compared to a & b, it takes longer for allele A to go to fixation.

__d vs. f vs. g__: e has a smaller population size, there are more fluctuations in allele frequencies. The selective advantage is also small (hs=0.005), it means drift can overwhelm the selectio, A allele could be lost to fixed. f and g have larger population size, under weak positive selection, allele A slowly goes to fixation.


\  

## 6) DoManyGenerationsV2()
```{r}
DoManyGenerationsV2 <- function(h, s, popSize, p0, gmax){
    i=0
    while(i < gmax && p0 != 1 && p0 != 0){
        p0<-DoOneFullGeneration(h, s, n, p0)
        i = i + 1
    }
    return(c(i, p0))
}

# a
h=0.5
s=0.01
n=100
p0=0.5
gmax=500
for (i in 1:5){
    print(DoManyGenerationsV2(h, s, n, p0, gmax))
}
# b
h=0.5
s=0.01
n=100
p0=1/200
gmax=500
for (i in 1:5){
    print(DoManyGenerationsV2(h, s, n, p0, gmax))
}
```

\  

## 7) NewMutationManyTimes()
```{r}
DoManyGenerations <- function(h, s, popSize, p0, g){
    p_list <- c(p0)
    for(i in 1:g){
        p<-DoOneFullGeneration(h, s, n, p0)
        p_list<-append(p_list, p, after = length(p_list))
        p0<-p
    }
    return(p_list)
}


NewMutationManyTimes <- function(h, s, popSize, m){
    p0 = 1/(2*popSize)
    p_list <- c()
    for (i in 1:m){
        p_final = DoManyGenerationsV2(h, s, n, p0, gmax=2000)[2]
        p_list <- append(p_list, p_final, after = length(p_list))
    }
    return(p_list)
}

# m=1000
m = 500000
# a
h = 0.5
s = 0
popSize = 1000
sim_a <- NewMutationManyTimes(h, s, popSize, m)
sum(sim_a != 0)/m
mean(subset(sim_a, sim_a!= 0))

# b
h = 0.5
s = 0.001
popSize = 1000
sim_b <- NewMutationManyTimes(h, s, popSize, m)
sum(sim_b != 0)/m
mean(subset(sim_b, sim_b!= 0))

# c
h = 0.5
s = 0.01
popSize = 1000
sim_c <- NewMutationManyTimes(h, s, popSize, m)
sum(sim_c != 0)/m
mean(subset(sim_c, sim_b!= 0))

# d
h = 0.5
s = 0.001
popSize = 10^5
sim_d <- NewMutationManyTimes(h, s, popSize, m)
sum(sim_d != 0)/m
mean(subset(sim_d, sim_d!= 0))

# e
h = 0.5
s = 0.01
popSize = 10^5
sim_e <- NewMutationManyTimes(h, s, popSize, m)
sum(sim_e != 0)/m
mean(subset(sim_e, sim_e!= 0))
```

### Results
wait till the lecture on fixation probability
